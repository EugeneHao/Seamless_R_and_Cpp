## A Second Example
```{r echo = FALSE, message = FALSE, warning = FALSE}
library(Rcpp)
library(inline)
library(RcppArmadillo)
setwd("~/Documents/GitHub/Seamless_R_and_Cpp/")
```

### Problem Setting {-}
The context of the example is a vector autoregressive process of order one for two variables, or in formal notation a VAR(1). More generally, a VAR model consists of a number $K$ of endogenous variable $\mathbf{x}_t$. A VAR(p) process is then defined by a series of coefficient matrices $A_j$ with $j\in 1, \ldots, p$ such that
$$
\mathbf{x}_t = A_1 \mathbf{x}_{t-1} + \ldots + A_p \mathbf{x}_{t-p} + \mathbf{u}_t
$$ 

For example, we are considering the simplest case of two-dimensional VAR of order one, i.e. $\mathbf{x}_t = A_1 \mathbf{x}_{t-1} + \mathbf{u}_t$. 


### R solution {-}

```{r}
##parameter and error terms used through out
a <- matrix(c(0.5,0.1,0.1,0.5),nrow=2) 
u <- matrix(rnorm(10000),ncol=2)
##Letâ€™s start with the Rversion 
rSim <- function(coeff, errors) {
  simdata <- matrix(0, nrow(errors), ncol(errors))
  for (row in 2:nrow(errors)) {
    simdata[row,] = coeff %*% simdata[(row-1),] + errors[row,] 
  }
  return(simdata)
}

rData <- rSim(a, u)
```


### C++ Solution {-}
In this solution, we use **RcppArmadillo** via **inline** to compile, link and load C++ code. 
```{r}
code <- '
  arma::mat coeff = Rcpp::as<arma::mat>(a);
  arma::mat errors = Rcpp::as<arma::mat>(u);
  int m = errors.n_rows;
  int n = errors.n_cols;
  arma::mat simdata(m,n);
  simdata.row(0) = arma::zeros<arma::mat>(1,n); 
  for (int row=1; row<m; row++) {
    simdata.row(row) = simdata.row(row-1)*trans(coeff) + errors.row(row);
  }
  return Rcpp::wrap(simdata);
'
## create the compiled function
rcppSim <- cxxfunction(signature(a="numeric", u="numeric"), 
                       code, plugin="RcppArmadillo")
rcppData <- rcppSim(a,u)              # generated by C++ code
stopifnot(all.equal(rData, rcppData)) # checking results
```

> Note: 
> 
> 1. set `plugin = "RcppArmadillo"`, while in Chapter 2.2, we set `plugin = "Rcpp"`. 

### Comparison {-}
```{r}
suppressMessages(library(rbenchmark)) 
res<-benchmark(rcppSim(a,u),
               rSim(a,u),
               columns=c("test", "replications", "elapsed",
                           "relative", "user.self", "sys.self"),
               order="relative")

res
```

